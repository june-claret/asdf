<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Lunar Calendar Medication Tracker</title>
<style>
    :root{
        --bg:#f5f5f5; --surface:#fff; --text:#222; --sub:#666; --muted:#9aa3a9;
        --accent:#007cba; --accent-2:#9c27b0; --ok:#28a745; --warn-bg:#fde8ea; --warn-border:#c62828; --warn-text:#5d1a1d;
        --grid:#e7eaee; --chip:#eef3f8;
        --sheet-peek:64px; /* visible header height when collapsed on mobile */
    }
    body.dark{
        --bg:#0f1216; --surface:#151a20; --text:#e8eef5; --sub:#b7c1cc; --muted:#738092;
        --accent:#5aa9ff; --accent-2:#c67aff; --ok:#3fd57c; --warn-bg:#2a171a; --warn-border:#b34753; --warn-text:#ffb8c0;
        --grid:#232a33; --chip:#1f2730;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);}

    .container{max-width:100vw;margin:0 auto;padding:10px;min-height:100vh;background:var(--surface);padding-bottom:80px;position:relative;}

    .control-frame{margin-bottom:10px;padding:10px;background:rgba(127,127,127,.08);border-radius:6px;display:grid;grid-template-columns:1fr 1fr;gap:8px;}

    .button-row{display:flex;gap:8px;}
    .button-row.full{grid-column:1/-1;}

    .view-selector{display:flex;background:var(--surface);padding:3px;border-radius:4px;flex:1;height:40px;}
    .view-button{padding:6px 12px;background:#e0e0e0;border:none;border-radius:3px;cursor:pointer;font-size:13px;transition:.2s;color:#333;flex:1;}
    .view-button.active{background:var(--accent);color:#fff}
    .view-button:hover:not(.active){background:#cfd3d7}
    body.dark .view-button{background:#26303b;color:var(--sub)}
    body.dark .view-button.active{background:var(--accent);color:#0c1116}

    .dropdown-container{position:relative;display:inline-block;flex:1;min-width:0;}
    .dropdown-button{padding:8px 14px;background:var(--ok);color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:16px;width:100%;height:40px;line-height:24px;display:flex;align-items:center;justify-content:center}
    .dropdown-button:hover{filter:brightness(.95)}
    .dropdown-content{display:none;position:absolute;background:var(--surface);min-width:160px;box-shadow:0 8px 16px rgba(0,0,0,.25);border-radius:6px;z-index:10;margin-top:2px;overflow:hidden;border:1px solid rgba(0,0,0,.08);width:100%;}
    .dropdown-content.show{display:block}
    .dropdown-item{color:var(--text);padding:10px 14px;display:block;cursor:pointer;border:none;background:none;width:100%;text-align:left;font-size:14px}
    .dropdown-item:hover{background:rgba(127,127,127,.12)}

    /* NEW: Improved cycle controls container */
    .cycle-container{
        display:flex;
        align-items:center;
        gap:4px;
        background:var(--surface);
        padding:3px;
        border-radius:4px;
        height:40px;
        flex:1;
        min-width:0;
    }

    .cycle-button{
        padding:6px 10px;
        background:var(--accent-2);
        color:#fff;
        border:none;
        border-radius:3px;
        cursor:pointer;
        font-size:16px;
        height:34px;
        display:flex;
        align-items:center;
        justify-content:center;
        min-width:34px;
        flex-shrink:0;
    }
    .cycle-button:hover{filter:brightness(.95)}

    .cycle-arrows{
        display:none;
        align-items:center;
        gap:3px;
        flex:1;
        min-width:0;
    }
    .cycle-arrows.show{display:flex;}

    .shift-button{
        padding:4px 8px;
        background:var(--accent);
        color:#fff;
        border:none;
        border-radius:3px;
        cursor:pointer;
        font-size:12px;
        height:28px;
        min-width:28px;
        display:flex;
        align-items:center;
        justify-content:center;
    }
    .shift-button:hover{filter:brightness(.95)}

    .shift-display{
        font-size:11px;
        color:var(--sub);
        text-align:center;
        white-space:nowrap;
        flex:1;
        min-width:0;
        padding:0 4px;
    }

    .dark-toggle{padding:8px 12px;background:#445160;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:18px;flex:1;min-width:0;height:40px;display:flex;align-items:center;justify-content:center}
    body.dark .dark-toggle{background:#2b3642}

    /* NEW: Compact actions row to keep ü©∏ üíª ‚òÄÔ∏è/üåô on ONE line (even on mobile) */
    /* DESKTOP/TABLET default: actions row stays compact (content width) */
.actions-compact{
  display:flex;
  gap:8px;
  align-items:stretch;
  flex:0 0 auto;            /* keep it snug on desktop */
  min-width:auto;
}

/* Mobile: let it span the row but never wrap */
    .actions-compact > *{flex:1 1 0;min-width:0}

    /* Bottom disclaimer banner */
    .disclaimer-banner{
        position:fixed;
        bottom:0;
        left:0;
        right:0;
        background:var(--warn-bg);
        border-top:2px solid var(--warn-border);
        padding:10px;
        z-index:1000;
    }
    .disclaimer-banner a{
        color:var(--warn-text);
        font-weight:700;
        text-decoration:underline;
    }

    /* Responsive Calendar & Gregorian layout (fluid, no forced vh heights) */
    .calendar-grid{
        display:grid;
        grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));
        grid-auto-rows:minmax(120px, auto);
        gap:4px;
        width:100%;
        height:auto;
    }
    .gregorian-grid{display:none;width:100%;height:auto;}
    .gregorian-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding:10px;background:rgba(127,127,127,.08);border-radius:6px}
    .month-nav{display:flex;gap:10px;align-items:center}
    .month-button{padding:5px 10px;background:var(--accent);color:#fff;border:none;border-radius:3px;cursor:pointer}
    .month-button:hover{filter:brightness(.95)}
    .month-display{font-weight:bold;font-size:16px;min-width:150px;text-align:center}

    .week-grid{
        display:grid;
        grid-template-columns:repeat(7,1fr);
        gap:2px;
        /* let rows size to content; days enforce min-height */
    }
    .weekday-header{background:#e0e0e0;padding:5px;text-align:center;font-weight:bold;font-size:12px}
    body.dark .weekday-header{background:#2a3440;color:var(--sub)}
    .gregorian-day{border:1px solid rgba(0,0,0,.12);padding:4px;background:var(--surface);min-height:84px;font-size:11px;overflow:hidden;cursor:pointer;border-radius:4px;position:relative}
    .gregorian-day.other-month{background:rgba(127,127,127,.08);color:var(--muted)}
    .gregorian-day.today{background:#ffff99 !important;color:#000}
    body.dark .gregorian-day.today{background:#443b12;color:#fff}
    .gregorian-date{font-weight:bold;margin-bottom:2px}
    .gregorian-lunar-info{font-size:10px;color:var(--sub);margin-bottom:4px;display:flex;align-items:center;gap:4px}
    .g-moon{font-size:12px}
    .g-mood{position:absolute;top:4px;right:6px;font-size:14px}

    .day-box{border:1px solid rgba(0,0,0,.12);padding:6px;background:var(--surface);cursor:pointer;overflow-y:auto;font-size:clamp(8px,1.2vw,12px);line-height:1.1;word-wrap:break-word;display:flex;flex-direction:column;min-height:0;position:relative;border-radius:4px}
    .day-box.current-day{background:#ffff99 !important;color:#000}
    body.dark .day-box{border-color:#2a3440}
    .day-box:hover{background:rgba(127,127,127,.06)}
    .mood-indicator{position:absolute;top:2px;right:4px;font-size:14px}
    .day-header{font-weight:bold;margin-bottom:3px;font-size:clamp(9px,1.4vw,14px)}
    .moon-phase{color:#2276ff;font-size:clamp(7px,1vw,11px);margin-bottom:2px}
    .menstrual-phase{color:#b00020;font-size:clamp(7px,1vw,11px);margin-bottom:3px}
    .day-content{flex-grow:1;font-size:clamp(7px,1vw,10px);overflow-y:auto}
    .editable-content{background:rgba(127,127,127,.08);border:1px dashed rgba(0,0,0,.2);padding:2px;min-height:30px;cursor:text;white-space:pre-wrap;border-radius:4px}
    .editable-content:focus{outline:2px solid var(--accent);background:var(--surface)}
    .mood-row{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0 2px}
    .mood-chip{background:var(--chip);border-radius:999px;padding:2px 8px;display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;border:1px solid rgba(0,0,0,.08)}
    .mood-chip span{font-size:16px}
    .mood-chip.active{outline:2px solid var(--accent)}
    body.dark .editable-content{border-color:#3a4654;background:#1b222b}

    /* Hormone graph panel ‚Äì desktop defaults (inline) */
    #hormonePanel{
        display:none;
        margin-top:10px;
        background:var(--surface);
        border:1px solid rgba(0,0,0,.12);
        border-radius:8px;
        padding:10px 10px 12px;
    }
    body.dark #hormonePanel{border-color:#2a3440}
    #hormoneGraph{width:100%;height:220px;display:block}
    .graph-caption{font-size:11px;color:var(--sub);margin-top:6px}

    /* Sheet UI bits (hidden on desktop) */
    .sheet-handle,.sheet-header{display:none}

    /* Consent overlay */
    #consentOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:9999}
    #consentCard{max-width:760px;background:var(--surface);color:var(--text);border-radius:12px;padding:18px 18px 14px;border:2px solid var(--warn-border);box-shadow:0 10px 35px rgba(0,0,0,.35)}
    #consentCard h2{margin:0 0 8px 0}
    .consent-section{margin:10px 0;padding:10px;background:var(--warn-bg);border-radius:8px;border:1px solid var(--warn-border);color:var(--warn-text)}
    .consent-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
    .btn{padding:8px 12px;border:none;border-radius:6px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.secondary{background:#e0e0e0}
    body.dark .btn.secondary{background:#2a3440;color:#cfd8e3}

    /* Editor modal */
    #editorOverlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9998}
    #editorCard{width:min(720px,94vw);max-height:86vh;overflow:auto;background:var(--surface);color:var(--text);border-radius:12px;border:1px solid rgba(0,0,0,.12);box-shadow:0 10px 35px rgba(0,0,0,.35);padding:12px}
    .ed-header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:6px}
    .ed-title{font-weight:700}
    .ed-tabs{display:flex;gap:6px;margin:8px 0}
    .ed-tab{padding:6px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.12);background:var(--chip);cursor:pointer;font-size:13px;color:var(--text);}
    .ed-tab.active{background:var(--accent);color:#fff;border-color:transparent}
    body.dark .ed-tab:not(.active){color:var(--text);}
    .ed-section{margin-top:6px}
    .ed-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
    textarea.ed-input{width:100%;min-height:120px;border-radius:8px;border:1px dashed rgba(0,0,0,.2);padding:8px;background:rgba(127,127,127,.08);color:inherit}
    body.dark textarea.ed-input{background:#1b222b;border-color:#3a4654}
    .muted{color:var(--sub);font-size:12px}

    /* Scrim behind the sheet (mobile only) */
    #hormoneScrim{
        position:fixed; inset:0; background:rgba(0,0,0,.45);
        display:none; z-index:9985;
    }
    #hormoneScrim.show{ display:block; }

    /* Mobile / tablet enhancements */
    @media (max-width: 1024px){
        .calendar-grid{
            grid-template-columns:repeat(auto-fit, minmax(110px, 1fr));
            grid-auto-rows:minmax(110px, auto);
        }
    }

    @media (max-width:768px){
        .control-frame{display:flex;flex-direction:column;gap:8px;}
        .button-row{flex-direction:column;}
        .button-row > *{width:100%;}
        .view-selector{width:100%;justify-content:space-around}

        /* Cycle container adjustments for mobile */
        .cycle-container{justify-content:space-between;width:100%}
        .shift-display{font-size:10px;}

        /* Original mobile widths (still fine elsewhere) */
        .dropdown-container,.dark-toggle{width:100%}

        .calendar-grid{grid-template-columns:repeat(auto-fit, minmax(95px, 1fr));grid-auto-rows:minmax(100px, auto);gap:2px}
        .gregorian-day{min-height:74px;font-size:9.5px}
        .day-box{padding:4px}
        .mood-row{overflow-x:auto;white-space:nowrap}

        /* Keep the compact actions on a SINGLE LINE */
        .actions-compact{flex-wrap:nowrap}
        .actions-compact .dropdown-container,
        .actions-compact .dark-toggle,
        .actions-compact .cycle-container{width:auto} /* override 100% width inside compact row */
    }

    @media (max-width:480px){
        .calendar-grid{grid-template-columns:repeat(auto-fit, minmax(85px, 1fr));}
        .day-box{padding:3px; font-size: clamp(8px, 3vw, 11px);}
        .gregorian-day{font-size: clamp(8px, 3vw, 10px);}
        .view-selector{width:100%;justify-content:space-around}
        
        /* Extra tight on very small screens */
        .shift-display{font-size:9px;padding:0 2px;}
        .cycle-button{min-width:30px;padding:4px 8px;}
        .shift-button{min-width:24px;padding:2px 6px;}
    }

    @media (max-width:320px){
        .calendar-grid{grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); /* 1‚Äì2 col depending on width */ }
    }
</style>

<style>

/* === Desktop top-bar: single row === */
@media (min-width: 769px){
  .control-frame{
    display:grid;
    grid-template-columns: 1fr 1fr auto;
    align-items:center;
  }
  /* First button row (two toggle groups) spans first two columns */
  .control-frame .button-row:first-of-type{
    grid-column: 1 / span 2;
  }
  /* Actions cluster sits in third column, same row */
  .control-frame .button-row.full{
    grid-column: 3;
    grid-row: 1;
    justify-self:start; /* keep near the groups */
  }
}

</style>

<style id="desktop-two-column-overrides">

/* === Desktop layout: Left = toggles, Right = actions === */
@media (min-width: 769px){
  .control-frame{
    display:grid;
    grid-template-columns: 1fr 1fr;
    align-items:center;
    column-gap: 12px;
  }
  /* First button row (Medications/Notes + Lunar/Gregorian) occupies left half */
  .control-frame .button-row:first-of-type{
    grid-column: 1;
    min-width: 0;
  }
  /* Actions row (ü©∏ + arrows, üíª, üåô/‚òÄÔ∏è) occupies right half, same row */
  .control-frame .button-row.full{
    grid-column: 2;
    grid-row: 1;
    justify-self: end;
    min-width: 0;
  }
  /* Keep actions in a single line */
  .actions-compact{
    flex-wrap: nowrap;
    overflow: visible;
    justify-content: flex-end;
    gap: 8px;
  }
  .actions-compact > *{
    flex: 0 1 auto;
    min-width: 0;
  }
  /* Keep the arrows perfectly between the blood drop and data button */
  .cycle-container{
    display: flex;
    align-items: center;
    gap: 6px;
    flex: 0 1 auto;
    min-width: 0;
    white-space: nowrap; /* keep inner items together */
  }
  .cycle-arrows{
    display: flex !important;
    gap: 6px;
    flex: 0 1 auto;
    min-width: 0;
    white-space: nowrap;
    margin: 0 6px;      /* visual spacing between ü©∏ and üíª */
  }
  .shift-button{
    min-width: 28px;    /* ensure clickable area, avoids being "covered" */
    height: 28px;
  }
  .shift-display{
    max-width: 90px;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .dropdown-container{ flex: 0 1 auto; min-width: 0; }
  .dark-toggle{ flex: 0 0 auto; }
}

</style>

<style id="fill-right-half-overrides">

/* === Desktop tweak: right half should FILL the column === */
@media (min-width: 769px){
  .control-frame .button-row.full{
    grid-column: 2;
    grid-row: 1;
    justify-self: stretch;  /* stretch to fill the right half */
    width: 100%;
  }
  .control-frame .button-row.full .actions-compact{
    width: 100%;
    justify-content: space-between; /* spread buttons across the half */
    gap: 8px;
  }
  .control-frame .button-row.full .actions-compact > *{
    flex: 0 0 auto; /* don't grow oversized, just space them */
  }
}

</style>

<style id="desktop-grow-actions">

/* === Desktop sizing: make right-half buttons grow === */
@media (min-width: 769px){
  /* Spread across right half */
  .control-frame .button-row.full{
    justify-self: stretch;
    width: 100%;
  }
  .control-frame .button-row.full .actions-compact{
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
  }
  /* Make the three main groups share the space equally */
  .actions-compact > .cycle-container,
  .actions-compact > .dropdown-container,
  .actions-compact > .dark-toggle{
    flex: 1 1 0;
    min-width: 0;
  }
  /* Center content inside each block so buttons look larger */
  .cycle-container{ justify-content: center; white-space: nowrap; }
  .dropdown-container{ display: flex; }
  .dropdown-container .dropdown-button{ width: 100%; display:flex; justify-content:center; }
  .dark-toggle{ width: 100%; display:flex; justify-content:center; }
  /* Comfortable arrow hit areas */
  .shift-button{ min-width: 32px; height: 32px; }
}

</style>

<style id="desktop-equal-groups">

/* === Desktop: right-half has 3 equal groups (cycle, data, theme) === */
@media (min-width: 769px){
  .control-frame{
    grid-template-columns: 1fr 1fr; /* left half, right half */
  }
  .control-frame .button-row:first-of-type{ grid-column: 1; }
  .control-frame .button-row.full{ 
    grid-column: 2; 
    grid-row: 1; 
    justify-self: stretch; 
    width: 100%;
  }
  .control-frame .button-row.full .actions-compact{
    width: 100%;
    display: flex;
    gap: 12px;
    justify-content: space-between; /* space across right half */
    align-items: center;
  }
  /* Make each group claim equal share of the right half */
  .actions-compact > .cycle-container,
  .actions-compact > .dropdown-container,
  .actions-compact > .dark-toggle{
    flex: 1 1 0;
    min-width: 0;
    display: flex;
    justify-content: center; /* center content inside each zone */
    align-items: center;
  }
  /* Reset earlier width:100% inflations so the groups match in size */
  .actions-compact > .dropdown-container .dropdown-button{ width: auto; }
  .actions-compact > .dark-toggle{ width: auto; }
  /* Cycle arrows spacing */
  .cycle-arrows{ display:flex !important; white-space:nowrap; margin: 0 6px; }
  .shift-button{ min-width: 32px; height: 32px; }
}

</style>

<style id="desktop-enlarge-inner">

/* === Desktop: enlarge buttons within each equal group === */
@media (min-width: 769px){
  /* Three equal groups already set. Make contents fill them. */
  .actions-compact{
    width: 100%;
  }
  .actions-compact > .cycle-container,
  .actions-compact > .dropdown-container,
  .actions-compact > .dark-toggle{
    flex: 1 1 0;
    min-width: 0;
    display: flex;
    align-items: center;
  }
  /* DATA button should fill its third */
  .actions-compact > .dropdown-container .dropdown-button{
    width: 100%;
    display: flex;
    justify-content: center;
  }
  /* THEME button should fill its third */
  .actions-compact > .dark-toggle{
    width: 100%;
    display: flex;
    justify-content: center;
  }
  /* CYCLE group: make the blood-drop button take remaining space,
     keep arrows fixed-size and centered between */
  .cycle-container{
    gap: 10px;
    justify-content: space-between;
  }
  .cycle-button{
    flex: 1 1 auto;             /* grows wide */
    display: flex;
    justify-content: center;
  }
  .cycle-arrows{
    flex: 0 0 auto;              /* stay compact */
    white-space: nowrap;
    margin: 0 6px;
  }
  .shift-button{ min-width: 34px; height: 34px; }
  .shift-display{ width: 56px; text-align: center; }
}

</style>

<style id="desktop-grid-actions">

/* === Desktop definitive: 3 equal columns for the right-side actions === */
@media (min-width: 769px){
  .control-frame{ grid-template-columns: 1fr 1fr; }
  .control-frame .button-row:first-of-type{ grid-column: 1; }
  .control-frame .button-row.full{ grid-column: 2; grid-row: 1; justify-self: stretch; width: 100%; }
  /* Force equal thirds using CSS Grid */
  .control-frame .button-row.full .actions-compact{
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* three equal groups */
    column-gap: 12px;
    width: 100%;
    align-items: center;
  }
  /* Ensure each group fills its cell */
  .actions-compact .cycle-container,
  .actions-compact .dropdown-container,
  .actions-compact .dark-toggle{
    width: 100%;
    min-width: 0;
  }
  /* Center content inside each cell */
  .actions-compact .cycle-container{ display:flex; justify-content:center; align-items:center; gap:10px; }
  .actions-compact .dropdown-container{ display:flex; justify-content:center; align-items:center; }
  .actions-compact .dropdown-container .dropdown-button{ width:100%; display:flex; justify-content:center; }
  .actions-compact .dark-toggle{ display:flex; justify-content:center; align-items:center; }
  /* Arrow sizing and spacing */
  .cycle-arrows{ display:flex !important; white-space:nowrap; margin:0 6px; }
  .shift-button{ min-width:32px; height:32px; }
}

</style>

<style id="mobile-cycle-shrink">

/* === Mobile-only: make cycle group a bit smaller so everything fits nicely === */
@media (max-width: 768px){
  .cycle-container{ gap: 4px; }
  .cycle-button{
    font-size: 14px;
    padding: 4px 8px;
    min-width: 28px;
    height: 32px;
  }
  .cycle-arrows{ gap: 2px; }
  .shift-button{
    min-width: 24px;
    height: 28px;
    font-size: 11px;
  }
  .shift-display{
    font-size: 10px;
    min-width: 36px;
  }
}

</style>

<style id="mobile-cycle-shrink-corrected">

/* === Mobile-only correction: keep arrows full size, tighten label === */
@media (max-width: 768px){
  .cycle-container{ gap: 4px; }
  .cycle-button{
    font-size: 14px;
    padding: 4px 8px;
    min-width: 28px;
    height: 32px;
  }
  .cycle-arrows{ gap: 4px; }              /* restore arrow spacing */
  .shift-button{
    min-width: 28px;                      /* keep arrows tappable */
    height: 30px;
    font-size: 12px;
  }
  .shift-display{
    font-size: 10px;
    min-width: 30px;                      /* narrower label so arrows stay close */
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
}
/* Extra-tight phones: allow even narrower label */
@media (max-width: 400px){
  .shift-display{ min-width: 26px; }
}

</style>

<style id="mobile-cycle-icon-only">

/* === Mobile ultra-compact cycle controls: icon-only, equal sizes === */
@media (max-width: 768px){
  /* Remove the label entirely so three buttons fit neatly */
  .shift-display{ display:none !important; }

  /* Make ü©∏, ‚óÄ, ‚ñ∂ the same square size for a clean row */
  .cycle-button,
  .shift-button{
    width: 32px;
    height: 32px;
    min-width: 32px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }

  .cycle-container{ gap: 6px; }
}

</style>

<style id="mobile-cycle-nowrap">

/* === Mobile: keep ü©∏ ‚óÄ ‚ñ∂ on one line and separate from data button === */
@media (max-width: 768px){
  .cycle-container{
    display: flex;
    flex: 0 0 auto;      /* don't grow into next control */
    white-space: nowrap; /* never wrap the three icons */
    gap: 4px;
    margin-right: 6px;   /* breathing room before üíª */
  }
  .cycle-button,
  .shift-button{
    width: 32px;
    height: 32px;
    min-width: 32px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex: 0 0 auto;      /* stay side-by-side */
  }
  .shift-display{ display: none !important; }
}

</style>

<style id="mobile-equal-columns">

/* === Mobile: lock actions into 3 equal columns so sizes don't jump === */
@media (max-width: 768px){
  .actions-compact{
    display: grid !important;
    grid-template-columns: repeat(3, 1fr);
    column-gap: 6px;
    width: 100%;
    align-items: center;
  }
  .actions-compact .cycle-container,
  .actions-compact .dropdown-container,
  .actions-compact .dark-toggle{
    width: 100%;
    min-width: 0;
  }
  .actions-compact .dropdown-container .dropdown-button,
  .actions-compact .dark-toggle{
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  /* keep cycle icons a fixed line and centered within their third */
  .actions-compact .cycle-container{
    display: flex;
    justify-content: center;
    align-items: center;
    white-space: nowrap;
    gap: 6px;
    margin-right: 0; /* grid handles spacing */
  }
}

</style>

<style id="mobile-fixed-cycle-icons">

/* === Mobile: fixed-size cycle icons; no dynamic growth === */
@media (max-width: 768px){
  /* three equal columns already set in this build */
  .actions-compact{ display: grid !important; grid-template-columns: repeat(3, 1fr); column-gap: 6px; }
  .actions-compact > *{ min-width: 0; }

  /* Cycle group: icon-only, fixed squares, centered; never wrap */
  .cycle-container{
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
  }
  .shift-display{ display: none !important; }
  .cycle-button, .shift-button{
    width: 28px;
    height: 28px;
    min-width: 28px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    line-height: 1;
    flex: 0 0 auto;
  }

  /* Data & Theme buttons fill their columns but do not overflow */
  .dropdown-container, .dark-toggle{ width: 100%; display: flex; }
  .dropdown-container .dropdown-button, .dark-toggle{
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
  }
}

</style>

<style id="always-show-arrows-css-only">

/* === Always show arrows; disable them when cycle is off (no JS changes) === */
.cycle-arrows{ display:flex !important; }
body:not(.show-graph) .shift-button{
  opacity:.45;
  pointer-events:none;
  filter:grayscale(100%);
}

</style>

<style id="mobile-smaller-arrows">

/* === Mobile: slightly smaller arrows to avoid bumping === */
@media (max-width: 768px){
  .cycle-container{ gap: 4px; }
  .shift-button{
    width: 26px;
    height: 26px;
    min-width: 26px;
    font-size: 12px;
  }
}

</style>

<style id="gregorian-dark-today-override">
/* Ensure gregorian 'today' text stays readable in dark mode */
body.dark #gregorianGrid .gregorian-day.today { background:#ffff99 !important; color:#000 !important; }
</style>

<style id="today-dark-overrides-strong">
/* Force readable text in highlighted cells for dark mode */
body.dark #gregorianGrid .gregorian-day.today,
body.dark #gregorianGrid .gregorian-day.today * { color:#000 !important; }
body.dark .day-box.current-day,
body.dark .day-box.current-day * { color:#000 !important; }
</style>
</head>
<body>
<!-- Consent / disclaimer overlay -->
<div id="consentOverlay">
  <div id="consentCard">
    <h2>Before you start</h2>
    <div class="consent-section" style="background:rgba(40,167,69,.08); border-color:rgba(40,167,69,.45); color:inherit;">
      <strong>Privacy & data:</strong> Your entries are stored locally in your browser (localStorage). Clearing site data/cookies or switching devices will erase them. Use <em>Export JSON</em> to back up, <em>Import JSON</em> to restore.
    </div>
    <div class="consent-section">
      <strong>Medical caution:</strong> Personal tracking only‚Äîthis is not medical advice. Always consult a clinician before starting, stopping, or cycling any medication.
      <br/><br/>
      <strong>Cisgender women:</strong> Cycling alongside your natural cycle can be risky. Some drugs have narrow safety margins. If you experiment, work with a clinician.
      <br/><br/>
      <strong>Trans women:</strong> Hormone cycling carries significant risks and can strongly affect mood and health. Build grounding practices (e.g., yoga/meditation) and work with a clinician‚Äîideally before starting.
      <br/><br/>
      <strong>Dosing caution:</strong> Smaller shifts are generally safer. Some medicines are potent at tiny doses. If something feels wrong, stay calm and seek appropriate care.
      <br/><br/>
      <strong>Liability:</strong> Use at your own risk. No warranties. You are responsible for your choices.
    </div>
    <div class="consent-actions">
      <button class="btn primary" id="consentAccept">I Understand</button>
    </div>
  </div>
</div>

<!-- Day editor modal -->
<div id="editorOverlay" role="dialog" aria-modal="true">
  <div id="editorCard">
    <div class="ed-header">
      <div class="ed-title" id="edTitle">Edit Day</div>
      <button class="btn secondary" onclick="closeEditor()">Close</button>
    </div>
    <div class="muted" id="edSubInfo"></div>
    <div class="ed-tabs">
      <button class="ed-tab active" id="tabMed" onclick="switchEdTab('med')">Medication</button>
      <button class="ed-tab" id="tabNotes" onclick="switchEdTab('notes')">Notes & Mood</button>
    </div>
    <div class="ed-section" id="edMed">
      <textarea id="edMedInput" class="ed-input" placeholder="Medication plan for this lunar day..."></textarea>
    </div>
    <div class="ed-section" id="edNotes" style="display:none">
      <div class="mood-row" id="edMoodRow"></div>
      <label class="muted">Personal notes</label>
      <textarea id="edFeeling" class="ed-input" placeholder="How did you feel during this part of the cycle? What worked? How can you prepare next time? (e.g., should you stock up on Nutella?)"></textarea>
    </div>
    <div class="ed-actions">
      <button class="btn primary" onclick="saveEditor()">Save</button>
    </div>
  </div>
</div>

<!-- Scrim for mobile sheet -->
<div id="hormoneScrim" aria-hidden="true"></div>

<div class="container" id="appContainer" style="display:none">
    <div class="control-frame">
        <!-- Row 1: Data view toggle -->
        <div class="button-row">
            <div class="view-selector" data-group="data">
                <button class="view-button active" onclick="setDataView('medication', this)">Medications</button>
                <button class="view-button" onclick="setDataView('notes', this)">Notes</button>
            </div>
            <div class="view-selector" data-group="calendar">
                <button class="view-button active" onclick="setCalendarView('lunar', this)">Lunar</button>
                <button class="view-button" onclick="setCalendarView('gregorian', this)">Gregorian</button>
            </div>
        </div>

        <!-- Row 3: Compact actions that must remain one line on mobile -->
        <div class="button-row full">
          <div class="actions-compact" role="group" aria-label="Quick actions">
            <!-- Slot A: menstrual button WITH cycle controls (always visible) -->
            <div class="cycle-container">
                <button class="cycle-button" id="cycleButton" onclick="toggleMenstrualCycle()" title="Toggle menstrual cycle">ü©∏</button>
                <div class="cycle-arrows" id="cycleArrows">
                    <button class="shift-button" onclick="shiftMenstrualCycle(-1)" title="Shift earlier">‚óÄ</button>
                    <span class="shift-display" id="shiftDisplay" aria-live="polite">Shift: 0</span>
                    <button class="shift-button" onclick="shiftMenstrualCycle(1)" title="Shift later">‚ñ∂</button>
                </div>
            </div>

            <!-- Slot B: data dropdown -->
            <div class="dropdown-container">
                <button class="dropdown-button" onclick="toggleDropdown()" title="Data menu" aria-haspopup="menu" aria-expanded="false">üíª</button>
                <div class="dropdown-content" id="dataDropdown" role="menu">
                    <button class="dropdown-item" onclick="importData()" role="menuitem">Import JSON</button>
                    <button class="dropdown-item" onclick="exportData()" role="menuitem">Export JSON</button>
                </div>
            </div>

            <!-- Slot C: theme toggle -->
            <button class="dark-toggle" onclick="toggleDarkMode()" id="darkToggle" title="Toggle theme">üåô</button>
          </div>
        </div>
    </div>

    <!-- Lunar Calendar Grid -->
    <div class="calendar-grid" id="calendarGrid"></div>

    <!-- Gregorian Calendar Grid -->
    <div class="gregorian-grid" id="gregorianGrid">
        <div class="gregorian-header">
            <div class="month-nav">
                <button class="month-button" onclick="changeMonth(-1)">‚óÄ</button>
                <div class="month-display" id="monthDisplay">January 2025</div>
                <button class="month-button" onclick="changeMonth(1)">‚ñ∂</button>
            </div>
            <button class="month-button" onclick="goToToday()">Today</button>
        </div>
        <div class="week-grid" id="weekGrid"></div>
    </div>

    <!-- Hormone Graph Panel (inline on desktop, bottom-sheet on mobile) -->
    <div id="hormonePanel" role="dialog" aria-label="Hormone graph panel" data-state="collapsed">
        <div class="sheet-handle" aria-hidden="true"></div>
        <div class="sheet-header" aria-hidden="false">
            <div class="sheet-title">Hormone Graph</div>
            <button class="sheet-toggle" id="sheetToggleBtn" type="button">Expand</button>
        </div>
        <div id="hormoneInner">
            <canvas id="hormoneGraph" width="1400" height="440" aria-label="Illustrative Estradiol and Progesterone pattern across a 29-day cycle"></canvas>
            <div class="graph-caption">Illustrative only ‚Äì actual hormone levels vary per person. Marker aligns to your shifted cycle day.</div>
        </div>
    </div>

    <!-- Bottom disclaimer banner -->
    <div class="disclaimer-banner">
        <a href="#" onclick="showConsent(); return false;">
            ‚ö†Ô∏è View medical disclaimer & privacy terms
        </a>
    </div>
</div>

<input type="file" id="fileInput" accept=".json" style="display:none;"/>

<script>
class LunarMedsApp {
    constructor() {
        this.medicationRegimens = this.loadState('lunarMedsRegimens') || Array(29).fill("");
        this.dayNotes = this.loadState('lunarMedsDayNotes') || Array.from({length:29}, () => ({feeling:"", mood:""}));
        this.menstrualCycleEnabled = false;
        this.menstrualShift = 0;
        this.currentLunarDay = null;
        this.dataView = 'medication';
        this.calendarView = 'lunar';
        this.currentMonth = new Date().getMonth();
        this.currentYear = new Date().getFullYear();

        this.moonEmojis = ['üåë','üåí','üåì','üåî','üåï','üåñ','üåó','üåò'];
        this.moodOptions = [
            {e:'üòä',k:'happy'},{e:'üôÇ',k:'calm'},{e:'üòê',k:'neutral'},
            {e:'üòï',k:'off'},{e:'üòî',k:'down'},{e:'üò≠',k:'cry'},
            {e:'üò§',k:'irritated'},{e:'üò∞',k:'anxious'},{e:'ü§í',k:'sick'},
            {e:'üí™',k:'strong'},{e:'üßò',k:'grounded'}
        ];

        this.updateLunarDay();
        this.initializeEventListeners();
        this.updateCalendar();
        this.scheduleUpdate();

        const settings = this.loadState('lunarMedsSettings');
        if (settings) {
            if (typeof settings.menstrualShift === 'number') {
                this.menstrualShift = settings.menstrualShift;
                const sd = document.getElementById('shiftDisplay');
                if (sd) sd.textContent = `Shift: ${this.menstrualShift}`;
            }
            if (settings.darkMode === true) document.body.classList.add('dark');
            if (settings.menstrualVisible) {
                this.menstrualCycleEnabled = true;
                document.getElementById('cycleArrows').classList.add('show');
                document.body.classList.add('show-graph');
                document.getElementById('hormonePanel').style.display = this.isMobileSheet() ? 'block' : 'block';
                // On mobile default collapsed; desktop inline visible
                this.setSheetState(this.isMobileSheet() ? 'collapsed' : 'expanded', {silent:true});
                this.drawHormoneGraph();
            }
            updateDarkToggleLabel();
             if (settings.calendarView) {
                this.calendarView = settings.calendarView;
                // update UI immediately
                document.querySelectorAll('.view-selector[data-group="calendar"] .view-button')
                    .forEach(btn => btn.classList.remove('active'));
                const btn = document.querySelector(`.view-selector[data-group="calendar"] .view-button:nth-child(${this.calendarView==='lunar'?1:2})`);
                if (btn) btn.classList.add('active');

                if (this.calendarView === 'lunar') {
                    document.getElementById('calendarGrid').style.display = 'grid';
                    document.getElementById('gregorianGrid').style.display = 'none';
                } else {
                    document.getElementById('calendarGrid').style.display = 'none';
                    document.getElementById('gregorianGrid').style.display = 'block';
                }
                this.updateCalendar();
            }
        }

        this._autosaveTimer = setInterval(() => this.saveAllState(), 30000);

        // Redraw graph on resize (keeps canvas crisp)
        window.addEventListener('resize', () => {
            if (this.menstrualCycleEnabled) this.drawHormoneGraph();
            // Keep sheet state sensible if crossing breakpoint
            this.syncSheetForViewport();
        });

        // Initialize sheet interactions
        this.initHormoneSheet();
    }

    /* ===== Mobile Sheet Helpers ===== */
    isMobileSheet(){ return window.matchMedia('(max-width: 768px)').matches; }

    initHormoneSheet(){
        const panel = document.getElementById('hormonePanel');
        const scrim = document.getElementById('hormoneScrim');
        const toggleBtn = document.getElementById('sheetToggleBtn');

        const expand = () => this.setSheetState('expanded');
        const collapse = () => this.setSheetState('collapsed');

        if (toggleBtn){
            toggleBtn.addEventListener('click', () => {
                const state = panel.getAttribute('data-state') === 'expanded' ? 'collapsed' : 'expanded';
                this.setSheetState(state);
            });
        }
        if (scrim){
            scrim.addEventListener('click', collapse);
        }
        // Swipe handling ‚Äì simple threshold gesture
        let startY = 0, dragging = false, moved = false;
        const start = (y) => { startY = y; dragging = true; moved = false; };
        const move = (y, evt) => {
            if (!dragging) return;
            const dy = y - startY;
            if (Math.abs(dy) > 10) moved = true;
            // prevent background scroll while swiping
            if (evt && moved) evt.preventDefault();
        };
        const end = (y) => {
            if (!dragging) return;
            const dy = y - startY;
            dragging = false;
            const isExpanded = panel.getAttribute('data-state') === 'expanded';
            const THRESH = 40;
            if (dy < -THRESH) { // swipe up
                this.setSheetState('expanded');
            } else if (dy > THRESH) { // swipe down
                this.setSheetState('collapsed');
            } else {
                // snap to nearest meaningful state
                this.setSheetState(isExpanded ? 'expanded' : 'collapsed');
            }
        };

        const handleArea = panel; // entire panel (header/handle area is at the top)
        // Touch events
        handleArea.addEventListener('touchstart', (e)=> start(e.touches[0].clientY), {passive:true});
        handleArea.addEventListener('touchmove',  (e)=> move(e.touches[0].clientY, e), {passive:false});
        handleArea.addEventListener('touchend',   (e)=> end((e.changedTouches[0]||{}).clientY ?? startY));
        // Mouse events (desktop/laptop)
        handleArea.addEventListener('mousedown', (e)=>{
            // only start drag if near the header area in mobile mode
            if (!this.isMobileSheet()) return;
            if (e.target.closest('.sheet-header') || e.clientY > window.innerHeight - 140) {
                start(e.clientY);
                const onMove = (ev)=> move(ev.clientY);
                const onUp = (ev)=>{ end(ev.clientY); window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
                window.addEventListener('mousemove', onMove);
                window.addEventListener('mouseup', onUp);
            }
        });

        // Start with correct sheet state for viewport
        this.syncSheetForViewport();
    }

    setSheetState(state, opts={}){
        const panel = document.getElementById('hormonePanel');
        const scrim = document.getElementById('hormoneScrim');
        const btn = document.getElementById('sheetToggleBtn');
        if (!panel) return;

        panel.setAttribute('data-state', state);
        if (btn) btn.textContent = state === 'expanded' ? 'Collapse' : 'Expand';

        // Scrim only on mobile + expanded
        const showScrim = this.isMobileSheet() && state === 'expanded';
        if (scrim){
            scrim.classList.toggle('show', showScrim);
        }

        // Redraw canvas after transition to ensure correct width
        if (!opts.silent){
            // small delay to let layout settle
            setTimeout(()=>{ if (this.menstrualCycleEnabled) this.drawHormoneGraph(); }, 180);
        }
    }

    syncSheetForViewport(){
        const panel = document.getElementById('hormonePanel');
        if (!panel) return;
        const visible = this.menstrualCycleEnabled;
        // On desktop, make sure panel behaves inline and is expanded (no scrim)
        if (!this.isMobileSheet()){
            if (visible){
                panel.style.display = 'block';
                this.setSheetState('expanded', {silent:true});
            } else {
                panel.style.display = 'none';
            }
            const scrim = document.getElementById('hormoneScrim');
            if (scrim) scrim.classList.remove('show');
        } else {
            // Mobile: if visible, show as sheet (collapsed by default)
            if (visible){
                panel.style.display = 'block';
                if (panel.getAttribute('data-state') !== 'expanded' && panel.getAttribute('data-state') !== 'collapsed'){
                    this.setSheetState('collapsed', {silent:true});
                }
            } else {
                panel.style.display = 'none';
            }
        }
    }

    /* ===== Core logic (unchanged features) ===== */
    calculateLunarPhase(date = new Date()) {
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();

        const a = Math.floor((14 - month) / 12);
        const y = year + 4800 - a;
        const m = month + 12 * a - 3;
        let jdn = day + Math.floor((153*m + 2)/5) + 365*y + Math.floor(y/4) - Math.floor(y/100) + Math.floor(y/400) - 32045;

        const refNewMoon = 2451550.26;
        const synodicMonth = 29.530588861;

        let phase = ((jdn - refNewMoon) % synodicMonth);
        if (phase < 0) phase += synodicMonth;

        const T = (jdn - 2451545.0) / 36525;
        const correction = 0.000325 * Math.sin((134.96 + 477198.86 * T) * Math.PI / 180);
        phase = (phase + correction) % synodicMonth;

        const dayNum = Math.floor(phase) + 1;
        return { phase, day: dayNum, illumination: (1 - Math.cos(2 * Math.PI * phase / synodicMonth)) / 2 };
    }
    updateLunarDay() {
        const lunarData = this.calculateLunarPhase();
        this.currentLunarDay = Math.min(lunarData.day, 29);
    }
    scheduleUpdate() {
        setTimeout(() => { this.checkForDayChange(); this.scheduleUpdate(); }, 300000);
    }
    checkForDayChange() {
        const old = this.currentLunarDay;
        this.updateLunarDay();
        if (old !== this.currentLunarDay) {
            this.updateCalendar();
            if (this.menstrualCycleEnabled) this.drawHormoneGraph();
        }
    }

    initializeEventListeners() {
        document.getElementById('fileInput').addEventListener('change', (e) => this.handleImport(e));
    }

    setDataView(view, clickedBtnEl) {
        this.dataView = view;
        document.querySelectorAll('.view-selector[data-group="data"] .view-button').forEach(btn => btn.classList.remove('active'));
        if (clickedBtnEl) clickedBtnEl.classList.add('active');
        this.updateCalendar();
    }
    setCalendarView(view, clickedBtnEl) {
        this.calendarView = view;
        document.querySelectorAll('.view-selector[data-group="calendar"] .view-button').forEach(btn => btn.classList.remove('active'));
        if (clickedBtnEl) clickedBtnEl.classList.add('active');

        if (view === 'lunar') {
            document.getElementById('calendarGrid').style.display = 'grid';
            document.getElementById('gregorianGrid').style.display = 'none';
        } else {
            document.getElementById('calendarGrid').style.display = 'none';
            document.getElementById('gregorianGrid').style.display = 'block';
        }
        this.updateCalendar();
        this.saveAllState();
    }
    updateCalendar() {
        if (this.calendarView === 'lunar') this.createLunarGrid();
        else this.createGregorianGrid();
    }

    createLunarGrid() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        for (let i = 0; i < 29; i++) {
            const dayBox = document.createElement('div');
            dayBox.className = 'day-box';
            dayBox.dataset.day = i;
            grid.appendChild(dayBox);
        }
        this.updateLunarCalendar();
    }
    updateLunarCalendar() {
        const currentIdx = (this.currentLunarDay ?? 1) - 1;
        const boxes = document.querySelectorAll('.day-box');

        boxes.forEach((box, i) => {
            box.classList.toggle('current-day', i === currentIdx);

            const moonPhase = this.getMoonPhase(i);
            const menstrualPhase = this.menstrualCycleEnabled ? this.getMenstrualPhase(i) : '';
            const notes = this.dayNotes[i] || {};

            let html = '';
            const moonEmoji = this.moonEmojis[Math.floor((i / 29) * 8) % 8];
            html += `<div class="day-header">${moonEmoji} Day ${i + 1}${i === currentIdx ? ' TODAY' : ''}${i === 28 ? ' (‚âà1.5d)' : ''}</div>`;

            if (moonPhase) html += `<div class="moon-phase">${moonPhase}</div>`;
            if (menstrualPhase) html += `<div class="menstrual-phase">${menstrualPhase}</div>`;
            if (notes.mood) html += `<span class="mood-indicator" title="Mood">${notes.mood}</span>`;

            if (this.dataView === 'medication') {
                const text = this.medicationRegimens[i] || '';
                const preview = text ? this.escapeHtml(text).replace(/\n/g,'<br>') : '<span class="muted">Click to edit‚Ä¶</span>';
                html += `<div class="day-content">${preview}</div>`;
            } else {
                const feeling = notes.feeling || '';
                const fPrev = feeling ? this.escapeHtml(feeling).replace(/\n/g,'<br>') : '<span class="muted">Click to edit‚Ä¶</span>';
                html += `<div class="day-content">${fPrev}</div>`;
            }
            box.innerHTML = html;
            box.onclick = () => this.openEditor(i, i + 1);
        });

        document.querySelectorAll('.editable-content').forEach(el => {
            el.addEventListener('blur', (e) => this.saveEdit(e));
            el.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') { e.preventDefault(); this.focusNextDay(e.target); }
            });
        });
        document.querySelectorAll('[data-role="moodrow"]').forEach(row=>{
            row.addEventListener('click', (e)=>{
                const btn = e.target.closest('.mood-chip'); if (!btn) return;
                const day = parseInt(row.dataset.day,10);
                const mood = btn.dataset.mood;
                this.setMood(day, mood);
            });
        });
    }

    createGregorianGrid() {
        const grid = document.getElementById('weekGrid');
        grid.innerHTML = '';

        const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        weekdays.forEach(day => {
            const h = document.createElement('div');
            h.className = 'weekday-header';
            h.textContent = day;
            grid.appendChild(h);
        });

        const firstDay = new Date(this.currentYear, this.currentMonth, 1);
        const lastDay = new Date(this.currentYear, this.currentMonth + 1, 0);
        const prevLastDay = new Date(this.currentYear, this.currentMonth, 0);

        const startDow = firstDay.getDay();
        const daysInMonth = lastDay.getDate();
        const daysInPrevMonth = prevLastDay.getDate();

        for (let i = startDow - 1; i >= 0; i--) {
            const d = document.createElement('div');
            d.className = 'gregorian-day other-month';
            d.innerHTML = `<div class="gregorian-date">${daysInPrevMonth - i}</div>`;
            grid.appendChild(d);
        }

        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const currentDate = new Date(this.currentYear, this.currentMonth, day);
            const lunarData = this.calculateLunarPhase(currentDate);
            const lunarDay = Math.min(lunarData.day, 29);
            const idx = lunarDay - 1;

            const d = document.createElement('div');
            d.className = 'gregorian-day';

            // Check if this is today - matching lunar view logic
            const isToday = today.getDate() === day && today.getMonth() === this.currentMonth && today.getFullYear() === this.currentYear;
            if (isToday) {
                d.classList.add('today');
            }

            const moonEmoji = this.moonEmojis[Math.floor((idx / 29) * 8) % 8];
            const moonPhase = this.getMoonPhase(idx);
            const menstrualPhase = this.menstrualCycleEnabled ? this.getMenstrualPhase(idx) : '';
            const mood = (this.dayNotes[idx]||{}).mood || '';

            let content = `<div class="g-mood">${mood||''}</div>`;
            content += `<div class="gregorian-date">${day}${isToday ? ' TODAY' : ''}</div>`;
            content += `<div class="gregorian-lunar-info"><span class="g-moon">${moonEmoji}</span> Lunar Day ${lunarDay}${lunarDay===29?' (‚âà1.5d)':''}</div>`;

            if (moonPhase) content += `<div style="font-size:9px;color:#2276ff;">${moonPhase}</div>`;
            if (menstrualPhase) content += `<div style="font-size:9px;color:#b00020;">${menstrualPhase.replace('<br>',' / ')}</div>`;

            if (this.dataView === 'medication') {
                const med = this.medicationRegimens[idx] || '';
                if (med) {
                    const preview = med.length > 70 ? med.substring(0,70) + '‚Ä¶' : med;
                    content += `<div style="font-size:9px;">${this.escapeHtml(preview)}</div>`;
                }
            } else {
                const notes = this.dayNotes[idx] || {};
                if (notes.feeling) {
                    const preview = notes.feeling.length>70?notes.feeling.substring(0,70)+'‚Ä¶':notes.feeling;
                    content += `<div style="font-size:9px;color:var(--sub)">${this.escapeHtml(preview)}</div>`;
                }
            }

            d.innerHTML = content;
            d.onclick = () => this.openEditor(idx, lunarDay, {date: currentDate});
            grid.appendChild(d);
        }

        const totalCells = grid.children.length;
        const remaining = 49 - totalCells;
        for (let day = 1; day <= remaining; day++) {
            const d = document.createElement('div');
            d.className = 'gregorian-day other-month';
            d.innerHTML = `<div class="gregorian-date">${day}</div>`;
            grid.appendChild(d);
        }

        const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        document.getElementById('monthDisplay').textContent = `${monthNames[this.currentMonth]} ${this.currentYear}`;
    }

    openEditor(lunarIdx, lunarDayNum, ctxInfo={}){
        this._editIndex = lunarIdx;
        const notes = this.dayNotes[lunarIdx] || {};
        const med = this.medicationRegimens[lunarIdx] || '';

        document.getElementById('edTitle').textContent = `Lunar Day ${lunarDayNum}${lunarDayNum===29?' (‚âà1.5d)':''}`;
        const moonPhase = this.getMoonPhase(lunarIdx);
        const menstrualPhase = this.menstrualCycleEnabled ? this.getMenstrualPhase(lunarIdx) : '';
        const when = ctxInfo.date ? ` ‚Ä¢ ${ctxInfo.date.toDateString()}` : '';
        document.getElementById('edSubInfo').innerHTML = `${moonPhase ? 'üåò '+moonPhase : ''}${menstrualPhase? '  ü©∏ '+menstrualPhase.replace('<br>',' / ') : ''}${when}`;

        document.getElementById('edMedInput').value = med;
        document.getElementById('edFeeling').value = notes.feeling || '';

        const row = document.getElementById('edMoodRow');
        row.innerHTML = this.renderMoodRow(notes.mood);
        row.onclick = (e)=>{
            const btn = e.target.closest('.mood-chip'); if (!btn) return;
            const m = btn.dataset.mood;
            this.setMood(lunarIdx, m, {silent:true});
            row.innerHTML = this.renderMoodRow(this.dayNotes[lunarIdx].mood);
        };

        document.getElementById('tabMed').classList.add('active');
        document.getElementById('tabNotes').classList.remove('active');
        document.getElementById('edMed').style.display='block';
        document.getElementById('edNotes').style.display='none';

        document.getElementById('editorOverlay').style.display='flex';
    }
    saveEditor(){
        const i = this._editIndex;
        if (i==null) return;
        this.medicationRegimens[i] = document.getElementById('edMedInput').value.trim();
        const n = this.dayNotes[i] || {};
        n.feeling = document.getElementById('edFeeling').value.trim();
        this.dayNotes[i] = n;
        this.saveAllState();
        this.updateCalendar();
        closeEditor();
    }

    saveEdit(event) {
        const el = event.target;
        const day = parseInt(el.dataset.day, 10);
        const type = el.dataset.type;
        const value = el.innerText.trim();

        if (type === 'medication') {
            this.medicationRegimens[day] = value;
        } else if (type === 'feeling') {
            if (!this.dayNotes[day]) this.dayNotes[day] = {};
            this.dayNotes[day].feeling = value;
        }
        this.saveAllState();
    }
    focusNextDay(currentEl) {
        const day = parseInt(currentEl.dataset.day, 10);
        const type = currentEl.dataset.type;
        let nextEl = null;

        if (type === 'medication') {
            if (day < 28) nextEl = document.querySelector(`.editable-content[data-day="${day+1}"][data-type="medication"]`);
        } else if (type === 'feeling') {
            if (day < 28) nextEl = document.querySelector(`.editable-content[data-day="${day+1}"][data-type="feeling"]`);
        }
        if (nextEl) nextEl.focus();
    }

    renderMoodRow(activeEmoji){
        return this.moodOptions.map(m=>{
            const isActive = activeEmoji===m.e;
            return `<div class="mood-chip ${isActive?'active':''}" data-mood="${m.e}" title="${m.k}"><span>${m.e}</span><small>${m.k}</small></div>`;
        }).join('');
    }
    setMood(day, emoji, opts={}){
        if (!this.dayNotes[day]) this.dayNotes[day]={};
        this.dayNotes[day].mood = emoji;
        if (!opts.silent) this.updateCalendar();
        this.saveAllState();
    }

    getMoonPhase(dayIdx) {
        const phases = {0:"New Moon",4:"Waxing Crescent",8:"First Quarter",12:"Waxing Gibbous",15:"Full Moon",19:"Waning Gibbous",23:"Last Quarter",26:"Waning Crescent"};
        return phases[dayIdx % 29] || '';
    }
    getMenstrualPhase(dayIdx) {
        const shifted = (dayIdx - this.menstrualShift + 29) % 29;
        if (shifted >= 0 && shifted < 4) return "Menstrual<br>Follicular";
        if (shifted >= 4 && shifted < 15) return "Follicular";
        if (shifted >= 15 && shifted < 16) return "Ovulation<br>Luteal";
        if (shifted >= 16 && shifted < 29) return "Luteal";
        return '';
    }

    toggleMenstrualCycle() {
        this.menstrualCycleEnabled = !this.menstrualCycleEnabled;
        const arrows = document.getElementById('cycleArrows');

        if (this.menstrualCycleEnabled) {
            arrows.classList.add('show');
        } else {
            arrows.classList.remove('show');
        }

        const panel = document.getElementById('hormonePanel');
        if (this.menstrualCycleEnabled) {
            document.body.classList.add('show-graph');
            panel.style.display = 'block';
            // On mobile, open collapsed; on desktop, just expanded inline
            this.setSheetState(this.isMobileSheet() ? 'collapsed' : 'expanded', {silent:true});
            this.drawHormoneGraph();
        } else {
            document.body.classList.remove('show-graph');
            panel.style.display = 'none';
            const scrim = document.getElementById('hormoneScrim');
            if (scrim) scrim.classList.remove('show');
        }

        this.saveAllState();
        this.updateCalendar();
    }
    shiftMenstrualCycle(direction) {
        this.menstrualShift = (this.menstrualShift + direction + 29) % 29;
        document.getElementById('shiftDisplay').textContent = `Shift: ${this.menstrualShift}`;
        if (this.menstrualCycleEnabled) this.drawHormoneGraph();
        this.updateCalendar();
        this.saveAllState();
    }

    changeMonth(direction) {
        this.currentMonth += direction;
        if (this.currentMonth > 11) { this.currentMonth = 0; this.currentYear++; }
        else if (this.currentMonth < 0) { this.currentMonth = 11; this.currentYear--; }
        this.createGregorianGrid();
    }
    goToToday() {
        const today = new Date();
        this.currentMonth = today.getMonth();
        this.currentYear = today.getFullYear();
        this.createGregorianGrid();
    }

    exportData() {
        const lunarData = this.calculateLunarPhase();
        const data = {
            regimens: this.medicationRegimens,
            notes: this.dayNotes,
            menstrualShift: this.menstrualShift,
            menstrualVisible: this.menstrualCycleEnabled,
            exported: new Date().toISOString(),
            currentLunarDay: this.currentLunarDay,
            lunarPhaseData: { phase: lunarData.phase, illumination: (lunarData.illumination * 100).toFixed(1) + '%' },
            version: "3.2"
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url;
        a.download = `lunar-calendar-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    handleImport(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);

                if (Array.isArray(data)) {
                    this.medicationRegimens = data;
                } else if (data.regimens && Array.isArray(data.regimens)) {
                    this.medicationRegimens = data.regimens;
                }
                if (data.notes) {
                    // Handle legacy data that might have 'remedy' field
                    this.dayNotes = data.notes.map(note => ({
                        feeling: note.feeling || '',
                        mood: note.mood || ''
                    }));
                }

                if (typeof data.menstrualShift === 'number') {
                    this.menstrualShift = data.menstrualShift;
                    document.getElementById('shiftDisplay').textContent = `Shift: ${this.menstrualShift}`;
                }
                if (typeof data.menstrualVisible === 'boolean') {
                    this.menstrualCycleEnabled = data.menstrualVisible;
                    const arrows = document.getElementById('cycleArrows');
                    if (this.menstrualCycleEnabled) {
                        arrows.classList.add('show');
                    } else {
                        arrows.classList.remove('show');
                    }
                    const panel = document.getElementById('hormonePanel');
                    panel.style.display = this.menstrualCycleEnabled ? 'block' : 'none';
                    document.body.classList.toggle('show-graph', this.menstrualCycleEnabled);
                    this.syncSheetForViewport();
                }

                while (this.medicationRegimens.length < 29) this.medicationRegimens.push("");
                this.medicationRegimens = this.medicationRegimens.slice(0, 29);

                while (this.dayNotes.length < 29) this.dayNotes.push({feeling:"", mood:""});
                this.dayNotes = this.dayNotes.slice(0, 29);

                this.saveAllState();
                this.updateCalendar();
                if (this.menstrualCycleEnabled) this.drawHormoneGraph();
                alert('Data imported successfully!');
            } catch (err) {
                alert('Error importing file: Invalid JSON format');
                console.error('Import error:', err);
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }
    loadState(key) {
        try { const saved = localStorage.getItem(key); if (saved) return JSON.parse(saved); }
        catch (e) { console.error(`Failed to load ${key}:`, e); }
        return null;
    }
    saveAllState() {
        try {
            localStorage.setItem('lunarMedsRegimens', JSON.stringify(this.medicationRegimens));
            localStorage.setItem('lunarMedsDayNotes', JSON.stringify(this.dayNotes));
            localStorage.setItem('lunarMedsSettings', JSON.stringify({
                menstrualShift: this.menstrualShift,
                menstrualVisible: this.menstrualCycleEnabled,
                darkMode: document.body.classList.contains('dark'),
                calendarView: this.calendarView
            }));
        } catch (e) { console.error('Failed to save state:', e); }
    }

    drawHormoneGraph(){
        const canvas = document.getElementById('hormoneGraph');
        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        canvas.width = Math.floor(rect.width * dpr);
        canvas.height = Math.floor(220 * dpr);
        ctx.scale(dpr, dpr);

        const W = rect.width, H = 220;
        const pad = {l:28, r:12, t:22, b:24};
        const plotW = W - pad.l - pad.r;
        const plotH = H - pad.t - pad.b;

        ctx.clearRect(0,0,W,H);
        ctx.fillStyle = getCss('--surface'); ctx.fillRect(0,0,W,H);

        ctx.strokeStyle = getCss('--grid'); ctx.lineWidth=1;
        for (let i=0;i<=6;i++){ const y=pad.t+i*(plotH/6); line(ctx,pad.l,y,pad.l+plotW,y); }

        ctx.fillStyle = getCss('--sub'); ctx.font = '11px system-ui, -apple-system, Segoe UI, Helvetica, Arial'; ctx.textAlign='center';
        for (let d=1; d<=29; d+=4){ const x = pad.l + (plotW*(d-1)/28); ctx.fillText(String(d), x, H-8); }

        ctx.fillStyle = getCss('--sub'); ctx.textAlign='center'; ctx.font = '12px system-ui, -apple-system, Segoe UI, Helvetica, Arial';
        const phaseRanges = [
            {label:'Menstrual', start:1, end:4},
            {label:'Follicular', start:4, end:14},
            {label:'Ovulation', start:14, end:16},
            {label:'Luteal', start:16, end:29},
        ];
        const xOfDay = (d)=> pad.l + plotW * (d-1)/28;
        const yOfVal = (v)=> pad.t + plotH * (1-v);
        phaseRanges.forEach(p=>{ const mid=(xOfDay(p.start)+xOfDay(p.end))/2; ctx.fillText(p.label, mid, 14); });

        const E2=[], P4=[];
        for(let d=1; d<=29; d++){
            let vE, vP;
            if (d<=5) vE = 0.10 + 0.01*d;
            else if (d<=13) vE = 0.12 + 0.06*(d-5);
            else if (d===14) vE = 1.00;
            else if (d<=17) vE = 0.45 - 0.15*(d-15);
            else if (d<=23) vE = 0.45 + 0.06*(d-17);
            else vE = Math.max(0.12, 0.78 - 0.12*(d-23));
            vE = Math.max(0.06, Math.min(1.0, vE));
            E2.push({d:vE});

            if (d<=14) vP = 0.04;
            else if (d<=22) vP = 0.10 + 0.10*(d-14);
            else vP = Math.max(0.05, 1.00 - 0.12*(d-22));
            vP = Math.max(0.04, Math.min(1.0, vP));
            P4.push({d:vP});
        }

        const drawSeries=(pts,color)=>{
            ctx.strokeStyle=color; ctx.lineWidth=3; ctx.lineJoin='round'; ctx.lineCap='round';
            ctx.beginPath();
            pts.forEach((p,i)=>{ const x=xOfDay(i+1), y=yOfVal(p.d); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
            ctx.stroke();
        }
        drawSeries(E2,'#ff4fb3');
        drawSeries(P4,'#45a3ff');

        const legend=[{label:'Estradiol',color:'#ff4fb3'},{label:'Progesterone',color:'#45a3ff'}];
        let lx=pad.l+8, ly=pad.t+42;
        legend.forEach(item => {
            // draw colored dash
            ctx.strokeStyle = item.color;
            ctx.lineWidth = 6;
            ctx.lineCap = 'round';
            ctx.setLineDash([]); // solid dash
            line(ctx, lx, ly, lx + 18, ly);

            // draw label text
            ctx.fillStyle = getCss('--text');
            ctx.font = '12px system-ui, -apple-system, Segoe UI, Helvetica, Arial';
            ctx.textAlign = 'left';
            ctx.fillText(item.label, lx + 26, ly + 4);

            ly += 18;
        });

        const todayLunar = this.currentLunarDay || 1;
        const shifted = ((todayLunar - 1 - this.menstrualShift + 29) % 29) + 1;
        const mx = xOfDay(shifted);
        ctx.save(); ctx.strokeStyle='rgba(255,203,72,.85)'; ctx.lineWidth=2; ctx.setLineDash([5,4]); line(ctx,mx,pad.t-4,mx,pad.t+plotH+4); ctx.restore();
        ctx.fillStyle='rgba(255,203,72,.95)'; ctx.font='12px system-ui, -apple-system, Segoe UI, Helvetica, Arial'; ctx.textAlign='center';
        ctx.fillText(`You: Day ${shifted}`, mx, pad.t-6);
    }

    escapeHtml(str) { return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
}

function line(ctx,x1,y1,x2,y2){ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();}
function getCss(name){return getComputedStyle(document.body).getPropertyValue(name).trim();}

let app;

function setDataView(view, btn) { if (app) app.setDataView(view, btn); }
function setCalendarView(view, btn) { if (app) app.setCalendarView(view, btn); }
function toggleMenstrualCycle() { if (app) app.toggleMenstrualCycle(); }
function shiftMenstrualCycle(direction) { if (app) app.shiftMenstrualCycle(direction); }
function changeMonth(direction) { if (app) app.changeMonth(direction); }
function goToToday() { if (app) app.goToToday(); }
function saveEditor(){ if (app) app.saveEditor(); }

function toggleDropdown(){
    const dd = document.getElementById('dataDropdown');
    const btn = dd?.previousElementSibling;
    dd.classList.toggle('show');
    if (btn) btn.setAttribute('aria-expanded', dd.classList.contains('show') ? 'true' : 'false');
}
function importData(){ document.getElementById('fileInput').click(); toggleDropdown(); }
function exportData(){ if (app) app.exportData(); toggleDropdown(); }

function toggleDisclaimer() {
    const full = document.getElementById('disclaimerFull');
    const header = document.getElementById('disclaimerHeader');
    const arrow = header ? header.querySelector('span') : null;
    if (!full || !arrow) return;
    if (full.style.display === 'none') { full.style.display = 'block'; arrow.textContent = '‚ñ≤ Click to collapse'; }
    else { full.style.display = 'none'; arrow.textContent = '‚ñº Click to expand'; }
}

function toggleDarkMode(){
    document.body.classList.toggle('dark');
    updateDarkToggleLabel();
    if (app){ app.saveAllState(); if (app.menstrualCycleEnabled) app.drawHormoneGraph(); }
}
function updateDarkToggleLabel(){
    const b = document.getElementById('darkToggle');
    if (!b) return;
    const dark = document.body.classList.contains('dark');
    // Emoji-only label per request
    b.textContent = dark ? '‚òÄÔ∏è' : 'üåô';
}

function showConsent(){ document.getElementById('consentOverlay').style.display='flex'; }
function hideConsent(){ document.getElementById('consentOverlay').style.display='none'; document.getElementById('appContainer').style.display='block'; }
function acceptConsent(){ localStorage.setItem('lunarMedsConsent','true'); hideConsent(); app = new LunarMedsApp(); }
function exportTemplate(){
    const empty = {
        regimens: Array(29).fill(""),
        notes: Array.from({length:29},()=>({feeling:"", mood:""})),
        menstrualShift: 0,
        menstrualVisible: false,
        version: "template-1.0"
    };
    const blob = new Blob([JSON.stringify(empty,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='lunar-tracker-empty-template.json';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function closeEditor(){ document.getElementById('editorOverlay').style.display='none'; }
function switchEdTab(which){
    document.getElementById('tabMed').classList.toggle('active', which==='med');
    document.getElementById('tabNotes').classList.toggle('active', which==='notes');
    document.getElementById('edMed').style.display = which==='med' ? 'block':'none';
    document.getElementById('edNotes').style.display = which==='notes' ? 'block':'none';
}

window.addEventListener('click', (e) => {
    if (!e.target.closest('.dropdown-container')) {
        const dd = document.getElementById('dataDropdown'); if (dd) dd.classList.remove('show');
        const btn = document.querySelector('.dropdown-container .dropdown-button');
        if (btn) btn.setAttribute('aria-expanded','false');
    }
});

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('consentAccept').addEventListener('click', acceptConsent);
    const cExp = document.getElementById('consentExport'); if (cExp) cExp.addEventListener('click', exportTemplate);

    const consented = localStorage.getItem('lunarMedsConsent') === 'true';
    if (!consented) {
        showConsent();
    } else {
        document.getElementById('appContainer').style.display='block';
        app = new LunarMedsApp();
    }
});
</script>

<script>
// ==== Add-on patch: 100% IndexedDB + per-day mirrors, without editing the original class ====

// IndexedDB helpers
const __IDB_NAME='lunar-meds', __IDB_STORE='state';
function __idbOpen(){
  return new Promise((res, rej)=>{
    const r = indexedDB.open(__IDB_NAME, 1);
    r.onupgradeneeded = e => {
      const db = e.target.result;
      if(!db.objectStoreNames.contains(__IDB_STORE)) db.createObjectStore(__IDB_STORE);
    };
    r.onsuccess = ()=>res(r.result);
    r.onerror = ()=>rej(r.error);
  });
}
async function __idbPut(k,v){
  const db = await __idbOpen();
  return new Promise((res, rej)=>{
    const tx = db.transaction(__IDB_STORE, 'readwrite');
    tx.objectStore(__IDB_STORE).put(v,k);
    tx.oncomplete = res; tx.onerror = ()=>rej(tx.error);
  });
}
async function __idbGet(k){
  const db = await __idbOpen();
  return new Promise((res, rej)=>{
    const tx = db.transaction(__IDB_STORE, 'readonly');
    const req = tx.objectStore(__IDB_STORE).get(k);
    req.onsuccess = ()=>res(req.result);
    req.onerror = ()=>rej(req.error);
  });
}

// Preload an in-memory cache from IDB (and migrate once from localStorage if present)
window.__idb_cache = {};
(async ()=>{
  try{
    const keys = ['lunarMedsRegimens','lunarMedsDayNotes','lunarMedsSettings'];
    for (const k of keys){
      let v = await __idbGet(k);
      if (v == null){
        const ls = localStorage.getItem(k);
        if (ls != null){
          try { v = JSON.parse(ls); await __idbPut(k, v); } catch(e){}
        }
      }
      if (v != null) window.__idb_cache[k] = v;
    }
  }catch(e){}
})();

// Mirror today's entry by date and lunar day for notifications
async function __idbSaveTodayEntry(lunarDay, text){
  try{
    const iso = new Date().toISOString().slice(0,10);
    await __idbPut(`date-${iso}`, { text, updatedAt: Date.now(), lunarDay });
    await __idbPut(`day-${lunarDay}`, { text, updatedAt: Date.now(), date: iso });
  }catch(e){}
}

// Wait until the app class exists, then override methods safely
(function waitAndPatch(){
  if (!(window.LunarMedsApp && LunarMedsApp.prototype)) {
    return setTimeout(waitAndPatch, 50);
  }

  // Override loadState to use IDB cache only (100% IDB after migration)
  const originalLoad = LunarMedsApp.prototype.loadState;
  LunarMedsApp.prototype.loadState = function(key){
    try{
      if (window.__idb_cache && Object.prototype.hasOwnProperty.call(window.__idb_cache, key)) {
        return window.__idb_cache[key];
      }
    }catch(e){}
    // Fallback to original if needed (shouldn't be necessary, but safe)
    try { return originalLoad ? originalLoad.call(this, key) : null; } catch(e){ return null; }
  };

  // Override saveAllState to write to IDB only
  LunarMedsApp.prototype.saveAllState = function(){
    const payloadSettings = {
      menstrualShift: this.menstrualShift,
      menstrualVisible: this.menstrualCycleEnabled,
      darkMode: document.body.classList.contains('dark'),
      calendarView: this.calendarView
    };
    __idbPut('lunarMedsRegimens', this.medicationRegimens);
    __idbPut('lunarMedsDayNotes', this.dayNotes);
    __idbPut('lunarMedsSettings', payloadSettings);
  };

  // Wrap saveEditor to mirror per-day text into IDB
  if (typeof window.saveEditor === 'function'){
    const __origSaveEditor = window.saveEditor;
    window.saveEditor = function(){
      try{
        var ta = document.getElementById('editorText');
        var txt = ta ? ta.value : '';
        if (window.app && typeof app.currentLunarDay === 'number') {
          __idbSaveTodayEntry(app.currentLunarDay, txt);
        }
      }catch(e){}
      return __origSaveEditor.apply(this, arguments);
    }
  }
})();
</script>

<script>
(function(){
  
function addGregorianPlaceholders(){
    const days = document.querySelectorAll('#gregorianGrid .gregorian-day:not(.other-month)');
    days.forEach(d => {
      // Detect a non-empty preview line added by the builder (font-size:9px + actual text)
      const previewEls = Array.from(d.querySelectorAll('div')).filter(el => {
        const s = el.getAttribute('style') || '';
        return s.includes('font-size:9px');
      });
      const previewHasText = previewEls.some(el => {
        const t = (el.textContent || '')
          .replace(/\u200B/g,'')
          .replace(/\u00A0/g,' ')
          .trim();
        return t.length > 0;
      });

      const hasPH = !!d.querySelector('.placeholder-hint');
      const shouldShow = !previewHasText; // show placeholder when no real preview text

      if (shouldShow && !hasPH){
        const ph = document.createElement('div');
        ph.className = 'placeholder-hint';
        ph.textContent = 'click to edit';
        ph.style.fontSize = '9px';
        ph.style.opacity = '0.85';
        // Insert after lunar info if present; else append to cell
        const after = d.querySelector('.gregorian-lunar-info');
        if (after && after.parentElement === d){
          after.insertAdjacentElement('afterend', ph);
        } else {
          d.appendChild(ph);
        }
      } else if (!shouldShow && hasPH){
        d.querySelector('.placeholder-hint')?.remove();
      }
    });
  }

  // Run on load and whenever the calendar view updates
  window.addEventListener('load', addGregorianPlaceholders);
  const mo = new MutationObserver(() => { setTimeout(addGregorianPlaceholders, 0); });
  mo.observe(document.body, {childList:true, subtree:true});
  // If the app object exists with updateCalendar, hook it
  const hook = () => {
    if (window.app && typeof app.updateCalendar === 'function' && !app.__phHooked){
      const orig = app.updateCalendar.bind(app);
      app.updateCalendar = function(){
        const r = orig();
        setTimeout(addGregorianPlaceholders, 0);
        return r;
      };
      app.__phHooked = true;
    }
  };
  hook();
  const ih = setInterval(() => { hook(); if (app && app.__phHooked) clearInterval(ih); }, 100);
})();
</script>
<style id="placeholder-style">
.placeholder-hint{ color: var(--sub); }
body.dark #gregorianGrid .gregorian-day.today .placeholder-hint{ color:#000 !important; }
</style>
</body>
</html>
